---
// ProjectsCard UI component
// Composed from the generic Card container.

import Card from './Card.astro';
import Button from './Button.astro';
import { Icon } from 'astro-icon/components';
import { getIconName } from '../../icons/iconMap';
import type { ProjectStatus } from '../../data/projects';
import { getInitials } from '../../../public/scripts/nameinitials.js';

interface Props {
  image?: string;
  title: string;
  languages?: string[];
  contributors?: string[];
  description?: string;
  information?: string;
  status?: ProjectStatus;
  links?: string;
  demo?: string;
  index?: number;
  organisation?: any;
}

const {
  image,
  title,
  languages = [],
  contributors = [],
  description,
  information,
  status = 'In development',
  links,
  demo,
  index = 0,
  organisation,
} = Astro.props;

const imageSrc =
  typeof image === 'object' && image?.src ? image.src : image;
const organisationSrc =
  typeof organisation === 'object' && organisation?.src ? organisation.src : organisation;

const languageIconKeyMap: Record<string, string> = {
  Astro: 'astro',
  Tailwind: 'tailwind',
  TailwindCSS: 'tailwind',
  TypeScript: 'typescript',
  Typescript: 'typescript',
  TS: 'typescript',
  Python: 'python',
  Vercel: 'vercel',
  React: 'react',
  Firebase: 'firebase',
  Wix: 'wix',
};

const getLanguageIconName = (lang: string): string | null => {
  const key = languageIconKeyMap[lang];
  return key ? getIconName(key as any) : null;
};

const statusClassMap: Record<ProjectStatus, string> = {
  'In development':
    'border-amber-400/60 bg-amber-500/10 text-amber-100',
  Ongoing:
    'border-purple-400/60 bg-purple-500/10 text-purple-100',
  Completed:
    'border-emerald-400/60 bg-emerald-500/10 text-emerald-100',
  Archived:
    'border-rose-400/60 bg-rose-500/10 text-rose-100',
};

const statusClasses = statusClassMap[status];
---

<div
  class="opacity-0 translate-y-3 project-card-animate"
  style={`animation-delay: ${index * 0.08}s`}
>
  <Card>
    <div class="project-card relative h-full" data-project-card>
      <div class="project-card-inner relative h-full w-full">
        <div class="project-card-face project-card-front flex h-full w-full flex-col space-y-2 text-sm text-[color:var(--text-main)]">
          <div class="flex w-full flex-1 gap-4">
            <div class="flex min-w-0 flex-1 flex-col space-y-1">
              <div class="flex items-start gap-2">
                <h2 class="text-base font-semibold tracking-[0.12em] uppercase break-words">
                  {title}
                </h2>
              </div>

              {description && (
                <p class="break-words text-[0.8rem] leading-relaxed text-[color:var(--text-muted)]">
                  {description}
                </p>
              )}

              {status && (
                <span class={`mt-1 inline-flex w-fit items-center rounded-full px-2 py-0.5 text-[0.7rem] font-semibold tracking-[0.12em] uppercase ${statusClasses}`}>
                  {status}
                </span>
              )}

              {languages.length > 0 && (
                <div class="flex w-full flex-wrap gap-2 pt-1 text-[0.75rem] text-[color:var(--text-muted)]">
                  {languages.map((lang) => {
                    const iconName = getLanguageIconName(lang);

                    if (iconName) {
                      return (
                        <span
                          class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-slate-500/40 bg-slate-950/40"
                          aria-label={lang}
                          title={lang}
                        >
                          <Icon
                            name={iconName}
                            class="h-3.5 w-3.5 text-[color:var(--text-main)]"
                          />
                        </span>
                      );
                    }

                    return (
                      <span
                        class="inline-flex items-center rounded-full border border-slate-500/40 bg-slate-950/40 px-2 py-0.5"
                      >
                        {lang}
                      </span>
                    );
                  })}
                </div>
              )}
            </div>

            {(imageSrc || organisationSrc) && (
              <div class="flex items-start">
                <div class="flex flex-col items-center gap-2">
                  {imageSrc && (
                    <div class="h-16 w-16 shrink-0 overflow-hidden rounded-md border border-purple-400/40 bg-slate-900">
                      <img
                        src={imageSrc}
                        alt={`${title} preview`}
                        loading="lazy"
                        class="h-full w-full object-cover"
                      />
                    </div>
                  )}
                  {organisationSrc && (
                    <div class="h-8 w-8 shrink-0 overflow-hidden rounded-full border border-purple-400/40 bg-slate-900">
                      <img
                        src={organisationSrc}
                        alt={`${title} organisation`}
                        loading="lazy"
                        class="h-full w-full object-cover"
                      />
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {(links || demo) && (
            <div class="mt-auto flex w-full flex-col gap-2 pt-1 sm:flex-row">
              {links && (
                <a
                  href={links}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex-1 min-w-0"
                >
                  <Button class="w-full border-black text-[color:var(--text-main)] hover:border-black hover:bg-black/10">
                    <span class="flex items-center justify-center gap-2">
                      <Icon name="logos:github-icon" class="h-3.5 w-3.5" />
                      <span>GitHub</span>
                    </span>
                  </Button>
                </a>
              )}

              {demo && (
                <a
                  href={demo}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex-1 min-w-0"
                >
                  <Button class="w-full border-sky-400 text-sky-100 hover:border-sky-300 hover:bg-sky-500/15">
                    <span class="flex items-center justify-center gap-2">
                      <Icon name="external-link" class="h-3.5 w-3.5" />
                      <span>Demo</span>
                    </span>
                  </Button>
                </a>
              )}
            </div>
          )}
        </div>

        <div class="project-card-face project-card-back flex h-full w-full flex-col justify-between space-y-2 text-sm text-[color:var(--text-main)]">
          <div class="space-y-2">
            <h3 class="text-[0.9rem] font-semibold tracking-[0.14em] uppercase text-[color:var(--text-main)]">
              Details
            </h3>
            {information && (
              <p class="text-[0.8rem] leading-relaxed text-[color:var(--text-muted)]">
                {information}
              </p>
            )}
          </div>

          {contributors.length > 0 && (
            <div class="pt-1">
              <p class="mb-1 text-[0.78rem] font-semibold text-[color:var(--text-main)]">
                Contributors
              </p>
              <div class="flex flex-wrap gap-2">
                {contributors.map((name) => (
                  <span
                    class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-slate-500/40 bg-slate-950/60 text-[0.7rem] font-semibold text-[color:var(--text-main)]"
                    title={name}
                    aria-label={name}
                  >
                    {getInitials(name)}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </Card>
</div>

<style>
  .project-card-animate {
    animation: project-card-enter 0.4s ease-out forwards;
  }

  @keyframes project-card-enter {
    from {
      opacity: 0;
      transform: translateY(0.75rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .project-card-inner {
    position: relative;
  }

  .project-card-face {
    transition: opacity 220ms ease-out;
    padding: 0.125rem;
  }

  .project-card-front {
    position: relative;
    z-index: 1;
    opacity: 1;
  }

  .project-card-back {
    position: absolute;
    inset: 0;
    z-index: 2;
    opacity: 0;
    pointer-events: none;
  }

  .project-card[data-flipped='true'] .project-card-front {
    opacity: 0;
  }

  .project-card[data-flipped='true'] .project-card-back {
    opacity: 1;
    pointer-events: auto;
  }
</style>

<script is:inline>
  if (typeof window !== 'undefined' && !window.__projectCardClickInit) {
    window.__projectCardClickInit = true;

    window.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      // Don't toggle when clicking links or buttons inside the card
      if (target.closest('a, button')) return;

      const card = target.closest('[data-project-card]');
      if (!card) return;

      const flipped = card.getAttribute('data-flipped') === 'true';
      card.setAttribute('data-flipped', flipped ? 'false' : 'true');
    });
  }
</script>
